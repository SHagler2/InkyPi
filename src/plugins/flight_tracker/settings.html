<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- Location Search -->
<div class="form-group" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
    <label class="form-label" style="margin: 0; white-space: nowrap;">Location:</label>
    <input type="text" id="citySearch" placeholder="Enter city name (e.g., Dallas, TX)" style="flex: 1; min-width: 200px;" class="form-input" />
    <button type="button" id="searchCityBtn" class="action-button compact">Search</button>
</div>
<div id="cityResults" style="margin-bottom: 10px;"></div>

<!-- Coordinates and Map Button -->
<div class="form-group" style="display: flex; align-items: center; gap: 15px; margin-bottom: 5px;">
    <input type="hidden" id="cityName" name="cityName" />
    <span>Latitude:</span>
    <input readonly type="text" id="latitude" name="latitude" class="form-input" style="width: 100px;" />
    <span>Longitude:</span>
    <input readonly type="text" id="longitude" name="longitude" class="form-input" style="width: 100px;" />
    <button type="button" id="openMap" class="action-button compact">Select on Map</button>
</div>
<div id="locationSource" style="font-size: 12px; color: #888; margin-bottom: 15px;"></div>

<!-- Search Radius -->
<div class="form-group">
    <label for="radius" class="form-label">Search Radius:</label>
    <select id="radius" name="radius" class="form-input">
        <option value="10">10 nm (~19 km)</option>
        <option value="25">25 nm (~46 km)</option>
        <option value="50">50 nm (~93 km)</option>
        <option value="100" selected>100 nm (~185 km)</option>
        <option value="150">150 nm (~278 km)</option>
        <option value="250">250 nm (~463 km)</option>
    </select>
</div>

<!-- Map Zoom -->
<div class="form-group">
    <label for="mapZoom" class="form-label">Map Zoom:</label>
    <select id="mapZoom" name="mapZoom" class="form-input">
        <option value="6">Very Wide (zoom 6)</option>
        <option value="7">Wide (zoom 7)</option>
        <option value="8" selected>Normal (zoom 8)</option>
        <option value="9">Close (zoom 9)</option>
        <option value="10">Closer (zoom 10)</option>
        <option value="11">Very Close (zoom 11)</option>
        <option value="12">Street Level (zoom 12)</option>
    </select>
    <small style="flex-basis: 100%; margin-top: 2px; color: var(--text-secondary, #888);">Map tiles are cached on first render. Change zoom to re-fetch.</small>
</div>

<!-- Units -->
<div class="form-group">
    <label for="units" class="form-label">Units:</label>
    <select id="units" name="units" class="form-input">
        <option value="aviation" selected>Aviation (ft, kts, nm)</option>
        <option value="metric">Metric (m, km/h, km)</option>
        <option value="imperial">Imperial (ft, mph, mi)</option>
    </select>
</div>

<!-- Hide Ground Traffic -->
<div class="form-group">
    <label for="hideGround" class="form-label">Hide Ground Traffic:</label>
    <div class="toggle-container">
        <input type="hidden" name="hideGround" value="false">
        <input type="checkbox" id="hideGround" name="hideGround" class="toggle-checkbox" value="true" checked>
        <label for="hideGround" class="toggle-label"></label>
    </div>
</div>

<!-- Show Tracks -->
<div class="form-group">
    <label for="showTracks" class="form-label">Show Flight Tracks:</label>
    <div class="toggle-container">
        <input type="hidden" name="showTracks" value="false">
        <input type="checkbox" id="showTracks" name="showTracks" class="toggle-checkbox" value="true" checked>
        <label for="showTracks" class="toggle-label"></label>
    </div>
    <small style="flex-basis: 100%; margin-top: 2px; color: var(--text-secondary, #888);">Show dotted trail lines behind each aircraft</small>
</div>

<!-- Data Source -->
<div class="form-group">
    <label for="dataSource" class="form-label">Data Source:</label>
    <select id="dataSource" name="dataSource" class="form-input">
        <option value="auto" selected>Auto (adsb.fi, fallback to airplanes.live)</option>
        <option value="adsbfi">adsb.fi only</option>
        <option value="airplaneslive">airplanes.live only</option>
    </select>
</div>

<!-- Auto-Refresh (time after display completes before next update) -->
<div class="form-group">
    <label for="autoRefresh" class="form-label">Auto-Refresh:</label>
    <select id="autoRefresh" name="autoRefresh" class="form-input">
        <option value="1">Every 1 minute</option>
        <option value="2">Every 2 minutes</option>
        <option value="5" selected>Every 5 minutes</option>
        <option value="10">Every 10 minutes</option>
        <option value="15">Every 15 minutes</option>
        <option value="0">Disabled (manual only)</option>
    </select>
    <small style="flex-basis: 100%; margin-top: 2px; color: var(--text-secondary, #888);">Time to wait after display finishes before fetching fresh data and refreshing again.</small>
</div>

<!-- Map Modal -->
<div id="mapModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('mapModal')">Ã—</span>
        <h2 id="modalTitle">Select Location</h2>
        <div class="separator"></div>
        <div id="map" style="width: 100%; height: 200px; margin: 10px 0px;"></div>
        <button id="closeMap" class="action-button">Save</button>
    </div>
</div>

<script>
    async function searchCity() {
        const cityName = document.getElementById('citySearch').value.trim();
        const resultsDiv = document.getElementById('cityResults');

        if (!cityName) {
            resultsDiv.innerHTML = '<div style="color: #dc3545; font-size: 14px;">Please enter a city name</div>';
            return;
        }

        resultsDiv.innerHTML = '<div style="font-size: 14px; color: var(--text-secondary, #888);">Searching...</div>';

        try {
            const response = await fetch('/search_city', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ city_name: cityName })
            });

            const result = await response.json();

            if (response.ok && result.cities) {
                let html = '<div style="font-size: 14px; margin-bottom: 8px; font-weight: bold;">Select a location:</div>';
                result.cities.forEach(city => {
                    html += `
                        <button type="button"
                                onclick="selectCity(${city.latitude}, ${city.longitude}, '${city.display.replace(/'/g, "\\'")}')"
                                style="display: block; width: 100%; padding: 10px; margin-bottom: 8px; background: #f8f9fa; border: 1px solid #ccc; border-radius: 4px; text-align: left; cursor: pointer; font-size: 14px;">
                            <strong>${city.display}</strong> (${city.country})
                        </button>
                    `;
                });
                resultsDiv.innerHTML = html;
            } else {
                resultsDiv.innerHTML = `<div style="color: #dc3545; font-size: 14px;">${result.error || 'No cities found'}</div>`;
            }
        } catch (error) {
            resultsDiv.innerHTML = '<div style="color: #dc3545; font-size: 14px;">Error searching for city</div>';
        }
    }

    function selectCity(lat, lon, displayName) {
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lon;
        document.getElementById('cityName').value = displayName;
        document.getElementById('locationSource').innerHTML =
            '<span style="color: #155724;">Custom location set</span>';
        document.getElementById('cityResults').innerHTML =
            `<div style="padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; font-size: 14px; color: #155724;">
                Selected: ${displayName}<br>
                <span style="font-size: 12px;">Lat: ${lat}, Lon: ${lon}</span>
            </div>`;
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const OSM_TILE_URL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
        const $latitude = document.querySelector('#latitude');
        const $longitude = document.querySelector('#longitude');
        const $openMap = document.querySelector('#openMap');
        const $closeMap = document.querySelector('#closeMap');
        const $locationSource = document.querySelector('#locationSource');

        document.getElementById('searchCityBtn').addEventListener('click', searchCity);
        document.getElementById('citySearch').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') { e.preventDefault(); searchCity(); }
        });

        // Load saved settings or defaults
        let hasCustomLocation = false;

        if (loadPluginSettings) {
            document.getElementById('latitude').value = pluginSettings.latitude || '';
            document.getElementById('longitude').value = pluginSettings.longitude || '';
            document.getElementById('cityName').value = pluginSettings.cityName || '';
            document.getElementById('radius').value = pluginSettings.radius || '100';
            document.getElementById('mapZoom').value = pluginSettings.mapZoom || '8';
            document.getElementById('units').value = pluginSettings.units || 'aviation';
            document.getElementById('hideGround').checked = pluginSettings.hideGround !== 'false';
            document.getElementById('showTracks').checked = pluginSettings.showTracks !== 'false';
            document.getElementById('dataSource').value = pluginSettings.dataSource || 'auto';
            // Map old DashPi sub-minute values to sensible e-ink defaults
            let savedRefresh = pluginSettings.autoRefresh || '5';
            const validRefreshValues = ['1', '2', '5', '10', '15', '0'];
            if (!validRefreshValues.includes(savedRefresh)) {
                savedRefresh = '5'; // Old sub-minute value, default to 5 min
            }
            document.getElementById('autoRefresh').value = savedRefresh;
            hasCustomLocation = !!(pluginSettings.latitude && pluginSettings.longitude);
        }

        // Fetch weather plugin location as fallback
        try {
            const resp = await fetch('/api/weather_location');
            const data = await resp.json();
            if (data.latitude && data.longitude) {
                if (!hasCustomLocation) {
                    $latitude.value = data.latitude;
                    $longitude.value = data.longitude;
                    $locationSource.innerHTML = 'Using Weather plugin location. Search above to override.';
                } else {
                    $locationSource.innerHTML = 'Custom location set.';
                }
            } else {
                if (!hasCustomLocation) {
                    $locationSource.innerHTML = 'No location set. Search for a city or set one in the Weather plugin.';
                }
            }
        } catch (e) {
            if (!hasCustomLocation) {
                $locationSource.innerHTML = 'No location set. Search for a city above.';
            }
        }

        let latitude = +$latitude.value;
        let longitude = +$longitude.value;
        let zoom = latitude && longitude ? 6 : 2.5;

        let map, marker;

        $openMap.addEventListener('click', () => {
            openModal('mapModal');
            setTimeout(() => {
                if (!map) {
                    map = L.map('map').setView([latitude, longitude], zoom);
                    L.tileLayer(OSM_TILE_URL).addTo(map);
                    marker = L.marker([latitude, longitude], { draggable: true }).addTo(map);
                    map.on('click', event => { marker.setLatLng(event.latlng); });
                }
            }, 100);
        });

        $closeMap.addEventListener('click', () => {
            const position = marker.getLatLng().wrap();
            const lat = Math.round(position.lat * 10000) / 10000;
            const lon = Math.round(position.lng * 10000) / 10000;
            $latitude.value = lat;
            $longitude.value = lon;
            document.getElementById('cityName').value = '';
            document.getElementById('citySearch').value = '';
            document.getElementById('cityResults').innerHTML =
                `<div style="padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; font-size: 14px; color: #155724;">
                    Selected: Map location<br>
                    <span style="font-size: 12px;">Lat: ${lat}, Lon: ${lon}</span>
                </div>`;
            $locationSource.innerHTML = '<span style="color: #155724;">Custom location set</span>';
            closeModal('mapModal');
        });
    });
</script>
