<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} v{{ version }} - {{ plugin.display_name }}</title>
    <script>
        (function() {
            const theme = localStorage.getItem('inkypi-theme') ||
                         (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <link rel= "stylesheet" type= "text/css" href= "{{ url_for('static',filename='styles/main.css') }}">
    <script src="{{ url_for('static', filename='scripts/dark_mode.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/response_modal.js') }}"></script>
    <script src="{{ url_for('static', filename='scripts/refresh_settings_manager.js') }}"></script>
    <!-- Select2 CSS -->
    <link href="{{ url_for('static', filename='styles/select2.min.css') }}" rel="stylesheet" />
    <!-- jQuery -->
    <script src="{{ url_for('static', filename='scripts/jquery.min.js') }}"></script>
    <!-- Select2 JS -->
    <script src="{{ url_for('static', filename='scripts/select2.min.js') }}"></script>

    <script>
        const pluginSettings = {{ plugin_settings | tojson if plugin_settings else {} }};
        const loadPluginSettings = Object.keys(pluginSettings).length > 0;
        const styleSettings = {{ style_settings | default(false) | tojson }};
        const loopEditMode = {{ loop_edit_mode | default(false) | tojson }};
        const loopAddMode = {{ loop_add_mode | default(false) | tojson }};
        const loopName = {{ loop_name | default('') | tojson }};
        const loopRefreshInterval = {{ loop_refresh_interval | default(0) | tojson }};

        let uploadedFiles = {};

        // Convert FormData to a plain object, collecting multi-value keys (e.g. imageFiles[]) into arrays
        function formDataToSettings(formData) {
            const settings = {};
            formData.forEach((value, key) => {
                if (key === 'plugin_id') return;
                if (key in settings) {
                    if (!Array.isArray(settings[key])) {
                        settings[key] = [settings[key]];
                    }
                    settings[key].push(value);
                } else {
                    // Keys ending with [] are always arrays (even with one value)
                    settings[key] = key.endsWith('[]') ? [value] : value;
                }
            });
            return settings;
        }

        async function handleAction(action) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const statusEnabled = window.pluginStatus && document.getElementById('showPluginStatus') && document.getElementById('showPluginStatus').checked;
            // Show spinner only when live status bar is off (or for loop actions)
            if (!statusEnabled || action === 'add_to_loop' || action === 'save_to_loop') {
                loadingIndicator.style.display = 'block';
            }

            // Gather plugin settings form data
            const form = document.getElementById('settingsForm');
            const scheduleForm = document.getElementById('scheduleForm');

            const formData = new FormData(form);
            let url = '{{ url_for("plugin.update_now_async") }}';
            let method = 'POST';
            let clearFormOnSubmit = false;

            // Add uploaded files to the form under its key
            Object.keys(uploadedFiles).forEach(key => {
                if (uploadedFiles[key].length > 0) {
                    uploadedFiles[key].forEach(file => {
                        formData.append(key, file);
                    });
                }
            });

            if (action == "add_to_loop"){
                // Convert form data to JSON for add_plugin_to_loop endpoint
                const loopFormData = new FormData(scheduleForm);
                const interval = parseInt(loopFormData.get("refresh_interval"));
                const unit = loopFormData.get("interval_unit");
                let intervalSeconds = interval;
                if (unit === "minutes") intervalSeconds = interval * 60;
                else if (unit === "hours") intervalSeconds = interval * 3600;
                else if (unit === "days") intervalSeconds = interval * 86400;

                const settings = formDataToSettings(formData);

                try {
                    const response = await fetch('{{ url_for("loops.add_plugin_to_loop") }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            loop_name: loopFormData.get("loop_name"),
                            plugin_id: '{{ plugin.id }}',
                            refresh_interval_seconds: intervalSeconds,
                            plugin_settings: settings
                        })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        closeModal('scheduleModal');
                        form.reset();
                        scheduleForm.reset();
                        uploadedFiles = {};
                        document.querySelectorAll('input[clear-on-submit]').forEach(input => {
                            input.value = '';
                            input.dispatchEvent(new Event('change'));
                        });
                        document.querySelectorAll('[delete-on-submit]').forEach(div => {
                            div.remove();
                        });
                    } else {
                        showResponseModal('failure', `Error! ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showResponseModal('failure', 'An error occurred while processing your request.');
                } finally {
                    loadingIndicator.style.display = 'none';
                }
                return; // Exit early for add_to_loop
            } else if (action == "add_to_loop_full") {
                // Add plugin to loop with full settings (from loops page add flow)
                const settings = formDataToSettings(formData);

                // Calculate refresh interval from edit fields (if visible)
                const addIntervalEl = document.getElementById('editRefreshInterval');
                const addUnitEl = document.getElementById('editIntervalUnit');
                const addInterval = addIntervalEl ? (parseInt(addIntervalEl.value) || 30) : 30;
                const addUnit = addUnitEl ? (parseInt(addUnitEl.value) || 60) : 60;
                const addRefreshSeconds = addInterval * addUnit;

                try {
                    const response = await fetch('{{ url_for("loops.add_plugin_to_loop") }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            loop_name: loopName,
                            plugin_id: '{{ plugin.id }}',
                            refresh_interval_seconds: addRefreshSeconds,
                            plugin_settings: settings
                        })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        sessionStorage.setItem('storedMessage', JSON.stringify({ type: 'success', text: `Added to loop "${loopName}"` }));
                        window.location.href = '/loops';
                    } else {
                        showResponseModal('failure', `Error! ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showResponseModal('failure', 'An error occurred while adding to loop.');
                } finally {
                    loadingIndicator.style.display = 'none';
                }
                return; // Exit early for add_to_loop_full
            } else if (action == "save_to_loop") {
                // Convert form data to JSON for update_plugin_settings endpoint
                const settings = formDataToSettings(formData);

                // Calculate refresh interval from edit fields (if visible)
                const editIntervalEl = document.getElementById('editRefreshInterval');
                const editUnitEl = document.getElementById('editIntervalUnit');
                const editInterval = editIntervalEl ? (parseInt(editIntervalEl.value) || 30) : 30;
                const editUnit = editUnitEl ? (parseInt(editUnitEl.value) || 60) : 60;
                const refreshIntervalSeconds = editInterval * editUnit;

                try {
                    const response = await fetch('{{ url_for("loops.update_plugin_settings") }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            loop_name: loopName,
                            plugin_id: '{{ plugin.id }}',
                            plugin_settings: settings,
                            refresh_interval_seconds: refreshIntervalSeconds
                        })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        // Store success message and redirect back to loops page
                        sessionStorage.setItem('storedMessage', JSON.stringify({ type: 'success', text: `Settings saved to loop "${loopName}"` }));
                        window.location.href = '/loops';
                    } else {
                        showResponseModal('failure', `Error! ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showResponseModal('failure', 'An error occurred while saving settings.');
                } finally {
                    loadingIndicator.style.display = 'none';
                }
                return; // Exit early for save_to_loop
            }

            // Show live status bar for "Update Now" (non-blocking)
            if (window.pluginStatus) {
                window.pluginStatus.showImmediate();
            }

            // Send data to the server (non-blocking — track via status polling)
            try {
                const response = await fetch(url, {method: method, body: formData});
                const result = await response.json();
                // Handle the response
                if (!response.ok) {
                    showResponseModal('failure', `Error!  ${result.error}`);
                    if (window.pluginStatus) window.pluginStatus.hideOnError();
                }
                closeModal('scheduleModal');
            } catch (error) {
                console.error('Error:', error);
                showResponseModal('failure', 'An error occurred while processing your request.');
                if (window.pluginStatus) window.pluginStatus.hideOnError();
            } finally {
                // Hide loading indicator after the action is complete
                loadingIndicator.style.display = 'none';
            }
        }

        function openModal(modal_id) {
            // Handle refresh settings modal specially with the manager
            if (modal_id === 'refreshSettingsModal' && editRefreshManager) {
                editRefreshManager.open({ refreshSettings });
                return;
            }

            // Generic modal opening for other modals
            const modal = document.getElementById(modal_id);
            if (modal) modal.style.display = 'block';
        }

        function closeModal(modal_id) {
            const modal = document.getElementById(modal_id);
            if (modal) modal.style.display = 'none';
        }

        // Close modal if the user clicks outside the modal content
        window.onclick = function (event) {
            const modal = document.getElementById('scheduleModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };

        function toggleCollapsible(button) {
            const content = button.nextElementSibling;
            const icon = button.querySelector(".collapsible-icon");
            button.classList.toggle("active");
            content.style.display = content.style.display === "block" ? "none" : "block";
            icon.textContent = content.style.display === "block" ? "▲" : "▼";
        }

        function selectedFrame(element) {
            if (!element) return; // Guard clause for null element

            // Remove the selected class from any previously selected option
            const previousSelection = document.querySelector('.image-option.selected');
            if (previousSelection) {
                previousSelection.classList.remove('selected');
            }

            // Add the selected class to the clicked option
            element.classList.add('selected');

            // Update the hidden input with the selected frame
            const selectedFaceName = element.getAttribute('data-face-name');
            document.getElementById('selected-frame').value = selectedFaceName;
        }

        function showFileName() {
            const fileInput = document.getElementById('imageUpload');
            const fileNameDisplay = document.getElementById('fileName');
            const fileNameText = document.getElementById('fileNameText');
            const uploadButtonLabel = document.getElementById('uploadButtonLabel');
            const removeFileButton = document.getElementById('removeFileButton');
            const file = fileInput.files[0];

            if (file) {
                fileNameText.textContent = `${file.name}`;
                fileNameDisplay.style.display = 'flex';  // Show the file name and remove button
                uploadButtonLabel.style.display = 'none';  // Hide the upload button label
            } else {
                fileNameDisplay.style.display = 'none';  // Hide if no file is selected
                uploadButtonLabel.style.display = 'block';  // Show the upload button label
            }
        }

        function removeFile() {
            const fileInput = document.getElementById('imageUpload');
            const fileNameDisplay = document.getElementById('fileName');
            const uploadButtonLabel = document.getElementById('uploadButtonLabel');

            fileInput.value = '';  // Clear the file input
            fileNameDisplay.style.display = 'none';  // Hide the file name and remove button
            uploadButtonLabel.style.display = 'block';  // Show the upload button label

            const hiddenElement = document.getElementById(`hidden-file-name`);
            if (hiddenElement) {
                hiddenElement.remove();
            }
        }

        // populate form values from plugin settings
        document.addEventListener('DOMContentLoaded', () => {
            if (!styleSettings){
                return;
            }
            if (loadPluginSettings) {
                if (pluginSettings.topMargin) {
                    document.getElementById('topMargin').value = pluginSettings.topMargin;
                }
                if (pluginSettings.bottomMargin) {
                    document.getElementById('bottomMargin').value = pluginSettings.bottomMargin;
                }
                if (pluginSettings.leftMargin) {
                    document.getElementById('leftMargin').value = pluginSettings.leftMargin;
                }
                if (pluginSettings.rightMargin) {
                    document.getElementById('rightMargin').value = pluginSettings.rightMargin;
                }
                // Populate background options (color or image)
                if (pluginSettings.backgroundOption) {
                    document.querySelector(`input[name="backgroundOption"][value="${pluginSettings.backgroundOption}"]`).checked = true;
                }

                // Set background color
                if (pluginSettings.backgroundColor) {
                    document.getElementById('backgroundColor').value = pluginSettings.backgroundColor;
                }

                // Populate text color
                if (pluginSettings.textColor) {
                    document.getElementById('textColor').value = pluginSettings.textColor;
                }

                // Handle background image selection
                const fileNameDisplay = document.getElementById('fileName');
                const fileNameText = document.getElementById('fileNameText');
                const uploadButtonLabel = document.getElementById('uploadButtonLabel');

                if (pluginSettings.backgroundImageFile) {
                    const filePath = pluginSettings.backgroundImageFile
                    const fileName = filePath.split('/').pop();

                    // display the file name
                    fileNameText.textContent = fileName;
                    fileNameDisplay.style.display = 'flex';
                    uploadButtonLabel.style.display = 'none';

                    // create a hidden input for the existing file
                    const hiddenInput = document.createElement("input");
                    hiddenInput.type = "hidden";
                    hiddenInput.name = "backgroundImageFile";
                    hiddenInput.value = filePath;
                    hiddenInput.id = `hidden-file-name`;
                    hiddenInput.setAttribute('delete-on-submit', '');
                    document.getElementById("hiddenFileInput").appendChild(hiddenInput);
                } else {
                    fileNameDisplay.style.display = 'none';
                    uploadButtonLabel.style.display = 'block';
                }

                let selectedFrameOption = document.querySelector(`.image-option[data-face-name="${pluginSettings.selectedFrame}"]`);
                selectedFrame(selectedFrameOption);
            } else {
                // set default values
                let selectedFrameOption = document.querySelector('.image-option');
                selectedFrame(selectedFrameOption);
            }

            // Setup interactive refresh settings for edit mode (removed - now handled in openModal)
        });
    </script>
</head>
<body>
    <div class="frame">
        <!-- Back Button -->
        <button onclick="window.location.href='{% if loop_edit_mode %}/loops{% else %}{{ url_for('main.main_page') }}{% endif %}'" class="back-button">← Back</button>

        <!-- Plugin Title and Icon -->
        <div class="app-header">
            <div class="header-content">
                <div class="title-container">
                    <img src="{{ url_for('plugin.image', plugin_id=plugin.id, filename='icon.png') }}" alt="{{ plugin.display_name }} icon" class="app-icon">
                    <h1 class="app-title"><span class="project-label">{{ project_name }} v{{ version }}</span> {{ plugin.display_name }}</h1>
                    {% if api_key and api_key.required %}<span class="api-key-label" title="{{api_key.service}} (Set {{api_key.expected_key}} in .env)">Requires API Key</span>{% endif %}
                </div>
                {% if not loop_edit_mode %}
                <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 13px; color: var(--text-secondary); white-space: nowrap;">
                    <input type="checkbox" id="showPluginStatus" style="width: 16px; height: 16px; cursor: pointer;" />
                    Live Status
                </label>
                {% endif %}
            </div>
            <div id="loadingIndicator" class="loading-indicator"></div>
        </div>
        <div class="separator"></div>

        <!-- Live Refresh Status -->
        <div id="pluginStatus" class="live-status-card">
            <span id="pluginStatusIcon" class="live-status-icon">&#9889;</span>
            <span id="pluginStatusText" class="live-status-text">Ready</span>
        </div>

        <!-- Include plugin settings -->
        <form id = "settingsForm" class="settings-form" onsubmit="return false;">
            <div class="settings-container">
                {% include settings_template %}

                <!-- Collapsible Style Settings Section -->
                {% if style_settings %}
                <div class="collapsible">
                    <button type="button" class="collapsible-header" onclick="toggleCollapsible(this)">
                        Style <span class="collapsible-icon">▼</span>
                    </button>
                    <div class="settings-container collapsible-content">
                        <div class="form-group">

                            <div class="form-group nowrap">
                                <label for="selected-frame" class="form-label">Frame:</label>
                                <div id="frame-selection" class="image-grid">
                                    {% for frame in frame_styles %}
                                    <div
                                        class="image-option"
                                        data-face-name="{{ frame.name }}"
                                        onclick="selectedFrame(this)"
                                    >
                                        <img
                                            src="{{ url_for('plugin.image', plugin_id='base_plugin', filename=frame.icon) }}"
                                            alt="{{ frame.name }}"
                                        />
                                    </div>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="selected-frame" name="selectedFrame" value="{{ frame_styles[0].Name }}" />
                            </div>

                            <div class="form-group">
                                <label for="margin" class="form-label">Margins:</label>
                                <div class="form-group nowrap">
                                    <label for="topMargin" class="form-label">Top</label>
                                    <input type="number" class="form-input" id="topMargin" name="topMargin" min="0" max="100" step="5"><span>px</span>
                                </div>
                                <div class="form-group nowrap">
                                    <label for="bottomMargin" class="form-label">Bottom</label>
                                    <input type="number" class="form-input" id="bottomMargin" name="bottomMargin" min="0" max="100" step="5"><span>px</span>
                                </div>
                                <div class="form-group nowrap">
                                    <label for="leftMargin" class="form-label">Left</label>
                                    <input type="number" class="form-input" id="leftMargin" name="leftMargin" min="0" max="100" step="5"><span>px</span>
                                </div>
                                <div class="form-group nowrap">
                                    <label for="rightMargin" class="form-label">Right</label>
                                    <input type="number" class="form-input" id="rightMargin" name="rightMargin" min="0" max="100" step="5"><span>px</span>
                                </div>
                            </div>
                        </div>

                        <!-- Background Color Option -->
                        <div class="form-group">
                            <label class="form-label">Background:</label>
                            <div class="form-group nowrap">
                                <label>
                                    <input type="radio" name="backgroundOption" value="color" checked>
                                    Color
                                </label>
                                <input type="color" id="backgroundColor" name="backgroundColor" class="color-picker" value="#ffffff">
                            </div>
                            <div class="form-group nowrap">
                                <label>
                                    <input type="radio" name="backgroundOption" value="image">
                                    Image
                                </label>
                                <label for="imageUpload" class="form-input file-upload-label" id="uploadButtonLabel">Upload Image</label>
                                <input type="file" clear-on-submit id="imageUpload" name="backgroundImageFile" accept="image/*" class="file-upload-input" onchange="showFileName()">
                                <div id="fileName" class="file-name" style="display: none;">
                                    <span id="fileNameText"></span>
                                    <button type="button" id="removeFileButton" class="remove-btn" onclick="removeFile()">X</button>
                                </div>
                            </div>
                        </div>

                        <!-- Hidden input fields to store existing file data -->
                        <div id="hiddenFileInput"></div>

                        <!-- Text Color Picker -->
                        <div class="form-group">
                            <label for="textColor" class="form-label">Text Color:</label>
                            <input type="color" id="textColor" name="textColor" class="color-picker" value="#000000">
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Hidden input to pass plugin id -->
            <input type="hidden" name="plugin_id" value="{{ plugin.id }}">

            {% if loop_edit_mode %}
            <div class="form-group">
                <label class="form-label">Refresh Interval:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="editRefreshInterval" min="1" value="30" class="form-input" style="flex: 1;">
                    <select id="editIntervalUnit" class="form-input" style="flex: 0 0 120px;">
                        <option value="1">Seconds</option>
                        <option value="60">Minutes</option>
                        <option value="3600">Hours</option>
                        <option value="86400">Days</option>
                    </select>
                </div>
                <small style="color: var(--text-secondary);">How often to refresh this plugin's data</small>
            </div>
            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    const totalSeconds = loopRefreshInterval || 1800;
                    const intervalInput = document.getElementById('editRefreshInterval');
                    const unitSelect = document.getElementById('editIntervalUnit');
                    if (totalSeconds >= 86400 && totalSeconds % 86400 === 0) {
                        unitSelect.value = '86400';
                        intervalInput.value = totalSeconds / 86400;
                    } else if (totalSeconds >= 3600 && totalSeconds % 3600 === 0) {
                        unitSelect.value = '3600';
                        intervalInput.value = totalSeconds / 3600;
                    } else if (totalSeconds >= 60 && totalSeconds % 60 === 0) {
                        unitSelect.value = '60';
                        intervalInput.value = totalSeconds / 60;
                    } else {
                        unitSelect.value = '1';
                        intervalInput.value = totalSeconds;
                    }
                });
            </script>
            {% endif %}

            <div class="buttons-container">
                {% if loop_edit_mode and loop_add_mode %}
                <button type="button" onclick="handleAction('add_to_loop_full')" class="action-button" style="width: 100%;">Add to "{{ loop_name }}"</button>
                {% elif loop_edit_mode %}
                <button type="button" onclick="handleAction('save_to_loop')" class="action-button" style="width: 100%;">Save Settings to "{{ loop_name }}"</button>
                {% else %}
                <button type="button" onclick="handleAction()" class="action-button left">Update Now</button>
                <button type="button" onclick="openModal('scheduleModal')" class="action-button right">Add to Loop</button>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Live Status Polling -->
    {% if not loop_edit_mode %}
    <script>
    (function() {
        const STORAGE_KEY = 'inkypi-plugin-status-enabled';
        const toggle = document.getElementById('showPluginStatus');
        const bar = document.getElementById('pluginStatus');
        const icon = document.getElementById('pluginStatusIcon');
        const text = document.getElementById('pluginStatusText');

        let hideTimeout = null;
        let refreshInProgress = false;
        let refreshStartTimestamp = 0;
        let pollTimer = null;

        // Restore toggle state from localStorage (default to checked)
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            toggle.checked = saved === null ? true : saved === 'true';
        } catch (e) { toggle.checked = true; }

        function applyToggleState() {
            if (toggle.checked) {
                bar.classList.remove('status-disabled');
                startPolling();
            } else {
                stopPolling();
                hideBar();
                bar.classList.add('status-disabled');
            }
        }

        toggle.addEventListener('change', function() {
            try { localStorage.setItem(STORAGE_KEY, toggle.checked); } catch (e) {}
            applyToggleState();
        });

        function showBar() {
            bar.style.visibility = 'visible';
        }

        function hideBar() {
            bar.style.visibility = 'hidden';
        }

        function setBarStyle(stage) {
            // Status bar uses consistent styling; icons convey state
        }

        const stageIcons = {
            refreshing:  '&#9889;',  generating:  '&#9889;',
            processing:  '&#9889;',  displaying:  '&#10024;',
            displayed:   '&#9989;',    idle:        '&#128164;',
            error:       '&#128308;',  starting:    '&#9889;',
            recording:   '&#127908;',  detecting:   '&#129504;',
            detected:    '&#127925;',  identifying: '&#128269;',
            rendering:   '&#127912;',  unidentified:'&#10067;',
        };

        const activeStages = new Set([
            'refreshing', 'generating', 'processing', 'displaying',
            'starting', 'recording', 'detecting', 'detected', 'identifying', 'rendering'
        ]);
        const terminalStages = new Set(['displayed', 'idle', 'error', 'unidentified']);

        function updateBar(stageIcon, message, stage) {
            icon.innerHTML = stageIcon;
            text.textContent = message || stage;
            setBarStyle(stage);
        }

        async function pollStatus() {
            try {
                const r = await fetch('/static/images/plugins/refresh_status.json?t=' + Date.now());
                if (!r.ok) return;
                const data = await r.json();
                if (!data || typeof data.stage !== 'string') return;

                const isActive = activeStages.has(data.stage);
                const isTerminal = terminalStages.has(data.stage);

                if (isActive) {
                    if (!refreshInProgress) {
                        refreshInProgress = true;
                        refreshStartTimestamp = data.timestamp;
                    }
                    if (hideTimeout) { clearTimeout(hideTimeout); hideTimeout = null; }

                    // Try plugin-specific status.json for granular stages
                    if (data.plugin_id && data.has_plugin_status) {
                        try {
                            const pr = await fetch('/images/' + encodeURIComponent(data.plugin_id) + '/status.json?t=' + Date.now());
                            if (pr.ok) {
                                const ps = await pr.json();
                                if (ps && typeof ps.timestamp === 'number' && ps.timestamp >= refreshStartTimestamp - 2) {
                                    updateBar(stageIcons[ps.stage] || stageIcons.generating, ps.detail, ps.stage);
                                    showBar();
                                    return;
                                }
                            }
                        } catch (e) {}
                    }

                    updateBar(stageIcons[data.stage] || stageIcons.generating, data.detail, data.stage);
                    showBar();
                    return;
                }

                // Refresh just completed — show result then auto-hide
                if (refreshInProgress && isTerminal) {
                    refreshInProgress = false;
                    updateBar(stageIcons[data.stage] || stageIcons.idle, data.detail, data.stage);
                    showBar();
                    if (hideTimeout) clearTimeout(hideTimeout);
                    hideTimeout = setTimeout(hideBar, 4000);
                }
            } catch (e) {}
        }

        function startPolling() {
            if (pollTimer) return;
            pollTimer = setInterval(pollStatus, 800);
        }

        function stopPolling() {
            if (pollTimer) { clearInterval(pollTimer); pollTimer = null; }
        }

        // Apply initial toggle state
        applyToggleState();

        // Expose for handleAction to call
        window.pluginStatus = {
            showImmediate: function() {
                refreshInProgress = true;
                refreshStartTimestamp = Date.now() / 1000;
                updateBar(stageIcons.refreshing, 'Starting update...', 'refreshing');
                showBar();
                startPolling();
            },
            hideOnError: function() {
                refreshInProgress = false;
                hideBar();
                if (!toggle.checked) stopPolling();
            }
        };
    })();
    </script>
    {% endif %}

    <!-- Success/Error Modal -->
    {% include 'response_modal.html' %}

    <!-- Loop Configuration Modal -->
    <div id="scheduleModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('scheduleModal')">×</span>
            <h2>Add to Loop</h2>
            <div class="separator"></div>
            <form id="scheduleForm" class="settings-form">
                <div class="form-group">
                    <label for="loop_name" class="form-label">Loop:</label>
                    <select id="loop_name" name="loop_name" class="form-input" required>
                        {% for loop_name in loops %}
                        <option value="{{loop_name}}">{{loop_name}}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="refresh_interval" class="form-label">Refresh Interval:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="refresh_interval" name="refresh_interval" min="1" value="30" required class="form-input" style="flex: 1;">
                        <select id="interval_unit" name="interval_unit" class="form-input" style="flex: 0 0 120px;">
                            <option value="minutes" selected>Minutes</option>
                            <option value="hours">Hours</option>
                            <option value="days">Days</option>
                        </select>
                    </div>
                    <small style="color: var(--text-secondary);">How often to refresh this plugin's data</small>
                </div>
            </form>
            <div class="buttons-container">
                <button type="button" onclick="handleAction('add_to_loop')" class="action-button">Save</button>
            </div>
        </div>
    </div>
</body>
</html>
